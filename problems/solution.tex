\documentclass{article}

\usepackage{amsmath}

\begin{document}

F

Placing animals from left to right is a Markov process, so we can use matrix multiplication. Let state vector have $i$th element representing the number of configurations when the current cage contains type $i$ animal. Transition matrix is the one matrix except where corresponding adjacent types are forbidden, in which case the matrix element is zero. We must zero out some state vector elements in certain stages because these cages forbid some types of animals. Time complexity is $O(N M^2)$. 

We can optimize with fast matrix exponentiation. This will give us time complexity $O(M^3 K \log{\frac{N}{K}}) = O(M^3 K \log{N})$. We can further precompute base matrices, yielding time complexity $O(M^3 \log{N} + M^2 K \log{\frac{N}{K}}) = O((M+K) M^2 \log{N})$. 

\end{document}
